<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
    </style>
</head>
<body class="text-gray-800 pb-10 min-h-screen">

    <!-- Header -->
    <div class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-md mx-auto px-4 py-3 flex items-center gap-3">
            <a href="index.html" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition">
                <i class="fa-solid fa-arrow-left text-gray-600"></i>
            </a>
            <h1 class="text-lg font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h1>
        </div>
    </div>

    <!-- Container -->
    <div class="max-w-md mx-auto p-4" id="history-container">
        <div class="text-center py-10 text-blue-500">
            <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <script>
        // *** ‡∏ô‡∏≥ URL ‡∏Ç‡∏≠‡∏á Apps Script ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyE9cbSOSoLUVfW3wJ7YUMZ3yyb8iEoGPENu_HVzIPPTurdCGwIo7YNQ64GLTilJjol/exec"; 

        document.addEventListener('DOMContentLoaded', async () => {
            const userId = localStorage.getItem('userId');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Login
            if(!userId) { 
                if (window.location.hostname === '') {
                    renderMockHistory(); 
                    return;
                } else {
                    window.location.href = 'index.html'; 
                    return; 
                }
            }

            const container = document.getElementById('history-container');
            
            try {
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Script
                const res = await fetch(`${APPS_SCRIPT_URL}?action=history&userId=${userId}`);
                const data = await res.json();
                
                if(data.status === 'success') {
                    
                    // üü¢ ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 'Confirmed' ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                    // (‡∏ï‡∏±‡∏î Cancelled ‡πÅ‡∏•‡∏∞ Success ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ)
                    const activeBookings = data.data.filter(item => item.status === 'Confirmed');

                    if (activeBookings.length > 0) {
                        container.innerHTML = activeBookings.map(item => {
                            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ß‡πà‡∏≤ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
                            const servicesList = item.services || "‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";

                            return `
                            <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition mb-3 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1.5 h-full bg-blue-500"></div>
                                <div class="flex justify-between items-start mb-3 border-b border-gray-100 pb-2">
                                    <div class="flex items-center gap-2">
                                        <div class="bg-blue-50 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm shadow-sm">
                                            ${item.time}
                                        </div>
                                        <div>
                                            <p class="font-bold text-gray-800 leading-tight">${formatDateThai(item.date)}</p>
                                            <p class="text-xs text-gray-400">‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</p>
                                        </div>
                                    </div>
                                    <span class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full border border-green-100 font-medium">
                                        <i class="fa-solid fa-clock"></i> ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
                                    </span>
                                </div>
                                <div class="space-y-2 text-sm">
                                    <p class="text-gray-700 flex items-center gap-2">
                                        <i class="fa-solid fa-scissors text-orange-500 w-5 text-center"></i> 
                                        <span>‡∏ä‡πà‡∏≤‡∏á: <span class="font-bold">${item.barber}</span></span>
                                    </p>
                                    <div class="bg-gray-50 p-2 rounded-lg border border-gray-100 flex items-start gap-2">
                                        <i class="fa-solid fa-list-check text-purple-500 w-5 text-center mt-0.5"></i>
                                        <span class="text-gray-600 text-xs leading-relaxed">${servicesList}</span>
                                    </div>
                                </div>
                            </div>
                            `;
                        }).join('');
                    } else {
                        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠ (‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤)
                        container.innerHTML = `
                            <div class="text-center py-16 opacity-60">
                                <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
                                    <i class="fa-regular fa-calendar-check text-4xl"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-600">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
                                <p class="text-sm text-gray-400 mt-1">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</p>
                                <a href="booking.html" class="inline-block mt-6 px-6 py-2 bg-blue-600 text-white rounded-full text-sm font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition">
                                    ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà
                                </a>
                            </div>`;
                    }

                } else {
                    container.innerHTML = `<div class="text-center py-10 opacity-50"><i class="fa-regular fa-calendar-xmark text-4xl mb-2"></i><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>`;
                }
            } catch (err) {
                console.error("Fetch Error:", err);
                container.innerHTML = `<div class="text-center py-10 text-red-500">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`;
            }
        });

        function formatDateThai(dateStr) {
            try {
                const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
                return new Date(dateStr).toLocaleDateString('th-TH', options);
            } catch(e) { return dateStr; }
        }

        // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Canvas Preview
        function renderMockHistory() {
            const container = document.getElementById('history-container');
            container.innerHTML = `
                <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition mb-3 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1.5 h-full bg-blue-500"></div>
                    <div class="flex justify-between items-start mb-3 border-b border-gray-100 pb-2">
                        <div class="flex items-center gap-2">
                            <div class="bg-blue-50 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm shadow-sm">
                                14:00
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 leading-tight">14 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569</p>
                                <p class="text-xs text-gray-400">‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</p>
                            </div>
                        </div>
                        <span class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full border border-green-100 font-medium">
                            <i class="fa-solid fa-clock"></i> ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
                        </span>
                    </div>
                    <div class="space-y-2 text-sm">
                        <p class="text-gray-700 flex items-center gap-2">
                            <i class="fa-solid fa-scissors text-orange-500 w-5 text-center"></i> 
                            <span>‡∏ä‡πà‡∏≤‡∏á: <span class="font-bold">‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</span></span>
                        </p>
                        <div class="bg-gray-50 p-2 rounded-lg border border-gray-100 flex items-start gap-2">
                            <i class="fa-solid fa-list-check text-purple-500 w-5 text-center mt-0.5"></i>
                            <span class="text-gray-600 text-xs leading-relaxed">‡∏ï‡∏±‡∏î‡∏ú‡∏°, ‡∏î‡∏±‡∏î‡∏ú‡∏°</span>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>