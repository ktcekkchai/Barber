<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จองคิวตัดผม</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .time-btn:disabled { background-color: #f3f4f6; color: #d1d5db; border-color: #e5e7eb; cursor: not-allowed; }
        .service-checkbox:checked + div { border-color: #2563eb; background-color: #eff6ff; }
        .service-checkbox:checked + div .check-icon { display: block; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 pb-32">

    <div class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-md mx-auto px-4 py-3 flex items-center gap-3">
            <a href="javascript:void(0);" onclick="goBack()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition">
                <i class="fa-solid fa-arrow-left text-gray-600"></i>
            </a>
            <h1 class="text-lg font-bold">จองคิวตัดผม</h1>
        </div>
    </div>

    <div class="max-w-md mx-auto p-4 space-y-6">
        
        <!-- 1. เลือกช่าง (ปรับปรุงใหม่ มีรูปภาพ) -->
        <section>
            <h2 class="text-lg font-semibold mb-3">1. เลือกช่างตัดผม</h2>
            <div class="grid grid-cols-2 gap-3" id="barber-list">
                <!-- รายชื่อช่างจะถูกสร้างด้วย JS ด้านล่าง -->
            </div>
        </section>

        <!-- 2. เลือกบริการ -->
        <section id="section-services" class="opacity-50 pointer-events-none transition-all duration-300">
            <h2 class="text-lg font-semibold mb-3">2. เลือกบริการ <span class="text-xs text-gray-500">(เลือกได้มากกว่า 1)</span></h2>
            <div class="space-y-2">
                <!-- Service 1 -->
                <label class="cursor-pointer block">
                    <input type="checkbox" class="service-checkbox hidden" value="1" data-name="ตัดผม" data-time="1" onchange="updateServiceSelection()">
                    <div class="border rounded-xl p-3 flex justify-between items-center bg-white hover:border-blue-300 transition-all">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600"><i class="fa-solid fa-scissors"></i></div>
                            <div>
                                <p class="font-bold text-sm">ตัดผม</p>
                                <p class="text-xs text-gray-400">ใช้เวลา 1 ชม.</p>
                            </div>
                        </div>
                        <i class="fa-solid fa-circle-check text-blue-600 text-xl check-icon hidden"></i>
                    </div>
                </label>
                <!-- Service 2 -->
                <label class="cursor-pointer block">
                    <input type="checkbox" class="service-checkbox hidden" value="2" data-name="แคะหู/ทำสี" data-time="1" onchange="updateServiceSelection()">
                    <div class="border rounded-xl p-3 flex justify-between items-center bg-white hover:border-blue-300 transition-all">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-600"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                            <div>
                                <p class="font-bold text-sm">แคะหู / ล้างตา / ทำสี</p>
                                <p class="text-xs text-gray-400">ใช้เวลา 1 ชม.</p>
                            </div>
                        </div>
                        <i class="fa-solid fa-circle-check text-blue-600 text-xl check-icon hidden"></i>
                    </div>
                </label>
                <!-- Service 3 -->
                <label class="cursor-pointer block">
                    <input type="checkbox" class="service-checkbox hidden" value="3" data-name="ดัด/ยืด" data-time="3" onchange="updateServiceSelection()">
                    <div class="border rounded-xl p-3 flex justify-between items-center bg-white hover:border-blue-300 transition-all">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-600"><i class="fa-solid fa-wind"></i></div>
                            <div>
                                <p class="font-bold text-sm">ดัดผม / ยืดผม</p>
                                <p class="text-xs text-gray-400">ใช้เวลา 3 ชม.</p>
                            </div>
                        </div>
                        <i class="fa-solid fa-circle-check text-blue-600 text-xl check-icon hidden"></i>
                    </div>
                </label>
            </div>
            <p id="total-time-display" class="text-right text-sm font-bold text-blue-600 mt-2 hidden">รวมเวลา: 0 ชม.</p>
        </section>

        <!-- 3. วันที่ -->
        <section id="section-date" class="opacity-50 pointer-events-none transition-all duration-300">
            <h2 class="text-lg font-semibold mb-3">3. เลือกวันที่</h2>
            <input type="date" id="input-date" class="w-full bg-white rounded-lg p-3 border border-gray-300 focus:border-blue-500 outline-none shadow-sm">
        </section>

        <!-- 4. เวลา -->
        <section id="section-time" class="opacity-50 pointer-events-none transition-all duration-300">
            <h2 class="text-lg font-semibold mb-3">4. เลือกเวลาเริ่มต้น</h2>
            <div id="time-container" class="grid grid-cols-3 gap-2">
                <div class="col-span-3 text-center text-sm text-gray-400 py-4 bg-gray-50 rounded-lg border border-dashed">
                    กรุณาเลือกบริการและวันที่ก่อน
                </div>
            </div>
        </section>

        <!-- 5. ข้อมูล -->
        <section id="section-info" class="opacity-50 pointer-events-none transition-all duration-300">
            <h2 class="text-lg font-semibold mb-3">5. ข้อมูลติดต่อ</h2>
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm space-y-3">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">ชื่อลูกค้า</label>
                    <input type="text" id="input-name" class="w-full rounded-lg p-3 border border-gray-200 bg-gray-50 text-gray-600 outline-none" readonly>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">เบอร์โทรศัพท์ <span class="text-red-500">*</span></label>
                    <input type="tel" id="input-phone" class="w-full rounded-lg p-3 border-2 border-gray-200 focus:border-blue-500 outline-none transition" placeholder="ระบุเบอร์โทรศัพท์" maxlength="10">
                </div>
            </div>
        </section>
    </div>

    <!-- Submit Button -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-lg z-50">
        <div class="max-w-md mx-auto">
            <button id="btn-submit" disabled class="w-full bg-gray-300 text-gray-500 py-3 rounded-xl font-bold transition-all duration-300">
                กรอกข้อมูลให้ครบถ้วน
            </button>
        </div>
    </div>

    <script>
        // ใช้ URL ล่าสุดที่คุณแจ้งไว้
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyVTLGK2w1nzUugv0FEBsJlcHLg0KrGvIJQq81JLt36i2dO5RIAd_Yaa_L9dP8yMY4l/exec"; 

        let state = {
            userId: localStorage.getItem('userId'),
            name: localStorage.getItem('userName'), 
            barberId: null, barberName: null,
            date: null, time: null, phone: "",
            services: "", 
            totalDuration: 0
        };

        // --- แก้ไขข้อมูลช่างตรงนี้ ---
        // คุณสามารถเปลี่ยน Link รูปภาพ (img) เป็นรูปจริงของช่างได้เลย
        const barbers = [
            { 
                id: 1, 
                name: "ช่างเกด", 
                img: "https://ktcekkchai.github.io/Barber/gat666.png" // รูปผู้หญิง
            },
            { 
                id: 2, 
                name: "ช่างติ๊ก", 
                img: "https://ktcekkchai.github.io/Barber/tik666.png" // รูปผู้ชาย
            }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            if (!state.userId) {
                 if (window.location.hostname === '') {
                     state.userId = "MockUser123";
                     state.name = "ลูกค้าจำลอง";
                 } else {
                     try { window.location.href = 'index.html'; } catch (e) { console.error(e); }
                     return; 
                 }
            }
            document.getElementById('input-name').value = state.name;
            
            // --- Render Barbers (แสดงผลรายชื่อช่าง) ---
            const barberContainer = document.getElementById('barber-list');
            barberContainer.innerHTML = barbers.map(b => `
                <button onclick="selectBarber(${b.id}, '${b.name}')" id="btn-barber-${b.id}" 
                    class="barber-btn bg-white border-2 border-transparent p-4 rounded-xl shadow-sm hover:border-blue-300 transition-all flex flex-col items-center gap-3 group">
                    
                    <!-- รูปโปรไฟล์ช่าง -->
                    <div class="relative">
                        <img src="${b.img}" class="w-16 h-16 rounded-full border-2 border-gray-100 object-cover shadow-sm group-hover:scale-105 transition-transform">
                        <div class="absolute bottom-0 right-0 w-4 h-4 bg-gray-300 border-2 border-white rounded-full status-dot"></div>
                    </div>
                    
                    <div class="text-center">
                        <p class="font-bold text-gray-800 text-lg">${b.name}</p>
                        <p class="text-xs text-gray-400">ช่างตัดผมมืออาชีพ</p>
                    </div>
                </button>
            `).join('');

            // Init Date
            const dateInput = document.getElementById('input-date');
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1); 
            const y = tomorrow.getFullYear();
            const m = String(tomorrow.getMonth() + 1).padStart(2, '0');
            const d = String(tomorrow.getDate()).padStart(2, '0');
            dateInput.min = `${y}-${m}-${d}`;
            
            dateInput.addEventListener('change', (e) => {
                state.date = e.target.value;
                state.time = null;
                fetchAvailableTimes();
            });

            document.getElementById('input-phone').addEventListener('input', (e) => {
                state.phone = e.target.value;
                checkReady();
            });
        });

        function goBack() {
            if (window.location.hostname === '') { Swal.fire('Preview', 'Go Back', 'info'); } 
            else { try { window.location.href = 'index.html'; } catch(e) {} }
        }

        function selectBarber(id, name) {
            state.barberId = id; state.barberName = name; 
            
            // Reset styles
            document.querySelectorAll('.barber-btn').forEach(el => {
                el.classList.remove('border-blue-600', 'bg-blue-50');
                el.classList.add('border-transparent', 'bg-white');
                // Reset dot color
                el.querySelector('.status-dot').classList.remove('bg-green-500');
                el.querySelector('.status-dot').classList.add('bg-gray-300');
            });

            // Highlight selected
            const selectedBtn = document.getElementById(`btn-barber-${id}`);
            selectedBtn.classList.remove('border-transparent', 'bg-white');
            selectedBtn.classList.add('border-blue-600', 'bg-blue-50');
            
            // Green dot
            selectedBtn.querySelector('.status-dot').classList.remove('bg-gray-300');
            selectedBtn.querySelector('.status-dot').classList.add('bg-green-500');
            
            document.getElementById('section-services').classList.remove('opacity-50', 'pointer-events-none');
            checkReady();
        }

        function updateServiceSelection() {
            const checkboxes = document.querySelectorAll('.service-checkbox:checked');
            let duration = 0;
            let names = [];
            
            checkboxes.forEach(cb => {
                duration += parseInt(cb.dataset.time);
                names.push(cb.dataset.name);
            });

            state.totalDuration = duration;
            state.services = names.join(', ');

            const display = document.getElementById('total-time-display');
            if(duration > 0) {
                display.textContent = `รวมเวลา: ${duration} ชั่วโมง`;
                display.classList.remove('hidden');
                document.getElementById('section-date').classList.remove('opacity-50', 'pointer-events-none');
                if(state.date) fetchAvailableTimes();
            } else {
                display.classList.add('hidden');
                document.getElementById('section-date').classList.add('opacity-50', 'pointer-events-none');
                document.getElementById('section-time').classList.add('opacity-50', 'pointer-events-none');
            }
            checkReady();
        }

        async function fetchAvailableTimes() {
            if(!state.barberId || !state.date || state.totalDuration === 0) return;

            const container = document.getElementById('time-container');
            document.getElementById('section-time').classList.remove('opacity-50', 'pointer-events-none');
            container.innerHTML = '<div class="col-span-3 text-center py-4 text-blue-500"><i class="fas fa-spinner fa-spin"></i> กำลังคำนวณคิวว่าง...</div>';

            const shopOpen = 9; 
            const shopClose = 19;
            const allStartTimes = [];
            
            for(let h = shopOpen; h < shopClose; h++) {
                allStartTimes.push(h + ":00");
            }

            try {
                const res = await fetch(`${APPS_SCRIPT_URL}?action=check_times&date=${state.date}&barberId=${state.barberId}`);
                const data = await res.json();
                const bookedTimes = data.status === 'success' ? data.data : [];

                renderSmartTimeSlots(container, allStartTimes, bookedTimes, state.totalDuration, shopClose);

            } catch (err) {
                console.warn(err);
                container.innerHTML = '<div class="col-span-3 text-center text-red-500">ตรวจสอบคิวล้มเหลว</div>';
            }
        }

        function renderSmartTimeSlots(container, allStartTimes, bookedTimes, neededDuration, shopCloseHour) {
            container.innerHTML = allStartTimes.map(startTime => {
                const startHour = parseInt(startTime.split(':')[0]);
                
                if (startHour + neededDuration > shopCloseHour) {
                    return ''; 
                }

                let isAvailable = true;
                for (let i = 0; i < neededDuration; i++) {
                    let checkTime = (startHour + i) + ":00";
                    if (bookedTimes.includes(checkTime)) {
                        isAvailable = false;
                        break;
                    }
                }

                if (!isAvailable) {
                    return `
                        <button disabled class="time-btn py-3 border border-gray-200 rounded-xl text-sm font-medium bg-gray-100 text-gray-400 cursor-not-allowed">
                            ${startTime} <br><span class="text-[10px]">(ไม่ว่าง)</span>
                        </button>
                    `;
                } else {
                    const endHour = startHour + neededDuration;
                    return `
                        <button onclick="selectTime('${startTime}')" id="btn-time-${startTime.replace(':','')}" 
                            class="time-btn py-3 border border-gray-200 rounded-xl text-sm font-medium bg-white text-gray-700 hover:border-blue-500 hover:shadow-md transition-all">
                            ${startTime} - ${endHour}:00
                        </button>
                    `;
                }
            }).join('');
            checkReady();
        }

        function selectTime(time) {
            state.time = time;
            document.querySelectorAll('.time-btn:not(:disabled)').forEach(el => {
                el.classList.replace('bg-blue-600', 'bg-white');
                el.classList.replace('text-white', 'text-gray-700');
                el.classList.replace('border-blue-600', 'border-gray-200');
            });
            
            const btn = document.getElementById(`btn-time-${time.replace(':','')}`);
            if(btn) {
                btn.classList.replace('bg-white', 'bg-blue-600');
                btn.classList.replace('text-gray-700', 'text-white');
                btn.classList.replace('border-gray-200', 'border-blue-600');
            }
            
            document.getElementById('section-info').classList.remove('opacity-50', 'pointer-events-none');
            setTimeout(() => {
                document.getElementById('input-phone').focus();
                document.getElementById('section-info').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 150);
            checkReady();
        }

        function checkReady() {
            const btn = document.getElementById('btn-submit');
            if (state.barberId && state.totalDuration > 0 && state.date && state.time && state.phone.length >= 9) {
                btn.disabled = false;
                btn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold shadow-lg transition-all flex items-center justify-center gap-2";
                btn.innerHTML = `ยืนยันการจอง (${state.totalDuration} ชม.) <i class="fa-solid fa-arrow-right"></i>`;
                btn.onclick = submitBooking;
            } else {
                btn.disabled = true;
                btn.className = "w-full bg-gray-200 text-gray-400 py-4 rounded-xl font-bold transition-all";
                btn.innerHTML = `กรอกข้อมูลให้ครบถ้วน`;
            }
        }

        async function submitBooking() {
            Swal.fire({ title: 'กำลังบันทึก...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            try {
                let finalServices = state.services;
                if (Array.isArray(finalServices)) {
                    finalServices = finalServices.join(', ');
                }

                const payload = {
                    action: "book",
                    ...state,
                    services: finalServices, 
                    duration: state.totalDuration 
                };

                const res = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    Swal.fire('สำเร็จ', 'บันทึกการจองเรียบร้อยแล้ว', 'success').then(() => {
                        window.location.href = 'history.html';
                    });
                } else {
                    Swal.fire('ขออภัย', data.message || 'เกิดข้อผิดพลาด', 'error').then(() => {
                        fetchAvailableTimes(); 
                    });
                }
            } catch (err) {
                Swal.fire('Error', 'การเชื่อมต่อขัดข้อง', 'error');
            }
        }
    </script>
</body>
</html>